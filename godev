#!/bin/zsh
#
# -----------------------------------------------------------------------------
# Welcome to godev!
#
# This software is free and open source.
# Feel free to use, modify, and share it as you wish.
#
# (See full Apache 2.0 License at the end of this file)
# -----------------------------------------------------------------------------
#
# godev - Multi-Folder Development Tree Demystification Tool
#
# DESCRIPTION
#   Demystify your multi-folder development tree. Navigate projects instantly,
#   see Git activity at a glance, and make sense of complex development structures.
#
# REQUIREMENTS
#   This script REQUIRES ZSH (Z Shell) and will NOT work with Bash.
#   It uses ZSH-specific features such as:
#   - Array indexing and parameter expansion flags
#   - Advanced parameter substitution
#   - ZSH-specific array operations
#
# USAGE
#   godev <command> [options]
#
# COMMANDS
#   nav, n <pattern>     Navigate to project (default command)
#   status, s [options]   Show project activity status
#   list, l              List all projects
#   ai-status            Check AI development tools status
#   version, v           Show version
#   help, h              Show help
#
# EXAMPLES
#   godev nav react          # Navigate to react project
#   godev react              # Same (nav is default)
#   godev status             # Show all project statuses
#   godev status -f 7        # Show active in last 7 days
#   godev list               # List all projects
#   godev ai-status          # Check AI tools
# -----------------------------------------------------------------------------

VERSION="2.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

# Base projects directory (adjust according to your configuration)
DEV_BASE="${HOME}/DEV"

# Configuration
MAX_DEPTH=5  # Maximum depth for recursive search (0 = unlimited)
READONLY_MODE=true  # Set to false to allow directory creation (for testing)

# Show help
show_help() {
    cat << EOF
${WHITE}godev${NC} - Multi-Folder Development Tree Demystification Tool

${CYAN}USAGE:${NC}
    godev <command> [options]

${CYAN}COMMANDS:${NC}
    ${GREEN}nav, n${NC} <pattern>        Navigate to project (default command)
    ${GREEN}status, s${NC} [options]     Show project activity status
    ${GREEN}list, l${NC}                 List all projects
    ${GREEN}ai-status${NC}               Check AI development tools status
    ${GREEN}version, v${NC}              Show version
    ${GREEN}help, h${NC}                 Show this help

${CYAN}EXAMPLES:${NC}
    godev nav react          # Navigate to react project
    godev react              # Same (nav is default)
    godev status             # Show all project statuses
    godev status -f 7        # Show active in last 7 days
    godev list               # List all projects
    godev ai-status          # Check AI tools

${CYAN}NOTE:${NC}
    This tool works in ${YELLOW}readonly mode${NC} by default during testing.
    It will ${YELLOW}not modify${NC} your development folder structure.

EOF
}

# Main command dispatcher
main() {
    local command="$1"
    shift
    
    # If no command provided, default to nav (for backward compatibility)
    if [[ -z "$command" ]] || [[ "$command" == -* ]]; then
        # Check if it's a version or help flag
        case "$command" in
            -v|--version)
                echo "godev version $VERSION"
                exit 0
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            *)
                # Default to nav command
                nav_command "$command" "$@"
                return
                ;;
        esac
    fi
    
    case "$command" in
        nav|n|"")
            nav_command "$@"
            ;;
        status|s|stats)
            status_command "$@"
            ;;
        list|l)
            list_command "$@"
            ;;
        ai-status|ai)
            ai_status_command "$@"
            ;;
        version|v)
            echo "godev version $VERSION"
            ;;
        help|h)
            show_help
            ;;
        *)
            echo -e "${RED}Unknown command: $command${NC}" >&2
            echo "Run 'godev help' for usage"
            exit 1
            ;;
    esac
}

# Navigation command (migrated from godev.sh)
nav_command() {
    local pattern=""
    local force_create=false
    
    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--force)
                force_create=true
                shift
                ;;
            -v|--version)
                echo "godev version $VERSION"
                return 0
                ;;
            -h|--help)
                echo "godev nav - Navigate to development project"
                echo ""
                echo "Usage: godev nav <pattern> [-f]"
                echo ""
                echo "Options:"
                echo "  <pattern>       Directory search pattern"
                echo "  -f, --force     Force directory creation (disabled in readonly mode)"
                echo "  -h, --help      Show this help"
                return 0
                ;;
            -*)
                echo -e "${RED}Unknown option: $1${NC}" >&2
                echo "Use 'godev nav -h' to see help"
                return 1
                ;;
            *)
                pattern="$1"
                shift
                ;;
        esac
    done
    
    # Verify that the base directory exists
    if [[ ! -d "$DEV_BASE" ]]; then
        echo -e "${RED}Error: Base directory $DEV_BASE does not exist${NC}" >&2
        return 1
    fi
    
    # Verify that a pattern was provided
    if [[ -z "$pattern" ]]; then
        echo -e "${YELLOW}Usage: godev nav <pattern> [-f]${NC}"
        echo "  -f, --force     Force directory creation"
        echo "  -h, --help      Show full help"
        return 1
    fi
    
    # Search for directories matching the pattern
    # Exclude: node_modules, .git, dist, build, vendor, .next, etc.
    local matches=()
    while IFS= read -r -d '' dir; do
        matches+=("$dir")
    done < <(find "$DEV_BASE" -maxdepth 3 -type d \
        -not -path "*/node_modules/*" \
        -not -path "*/.git/*" \
        -not -path "*/dist/*" \
        -not -path "*/build/*" \
        -not -path "*/vendor/*" \
        -not -path "*/.next/*" \
        -not -path "*/target/*" \
        -not -path "*/__pycache__/*" \
        -not -path "*/.venv/*" \
        -iname "*${pattern}*" -print0 2>/dev/null)
    
    local count=${#matches[@]}
    
    if [[ $count -eq 0 ]]; then
        # No matches found
        if [[ "$force_create" == true ]]; then
            if [[ "$READONLY_MODE" == true ]]; then
                echo -e "${YELLOW}[READONLY MODE]${NC} Would create directory: ${DEV_BASE}/${pattern}"
                echo "To actually create it, set READONLY_MODE=false in the script"
                return 0
            else
                local new_dir="${DEV_BASE}/${pattern}"
                mkdir -p "$new_dir"
                echo -e "${GREEN}✓${NC} Directory created: $new_dir"
                if [[ -n "$ZSH_VERSION" ]]; then
                    # In ZSH, we can't change directory from a script
                    # User needs to source it or we output the path
                    echo "Path: $new_dir"
                    echo "Run: cd $new_dir"
                fi
                return 0
            fi
        else
            echo -e "${YELLOW}No directory found matching pattern: $pattern${NC}"
            echo "Use 'godev nav $pattern -f' to create the directory"
            return 1
        fi
    elif [[ $count -eq 1 ]]; then
        # Single match - show directory
        local target_dir="${matches[1]}"
        echo -e "${GREEN}→${NC} ${target_dir}"
        if [[ "$READONLY_MODE" == true ]]; then
            echo -e "${GRAY}[READONLY MODE]${NC} Would navigate to: $target_dir"
            echo "Run: cd $target_dir"
        else
            if [[ -n "$ZSH_VERSION" ]]; then
                # Output path for sourcing
                echo "Path: $target_dir"
                echo "Run: cd $target_dir"
            fi
        fi
        return 0
    else
        # Multiple matches - show list
        echo -e "${CYAN}Found $count directories:${NC}"
        echo ""
        local i=1
        for dir in "${matches[@]}"; do
            local rel_path="${dir#$DEV_BASE/}"
            echo -e "  ${GREEN}[$i]${NC} ${rel_path}"
            ((i++))
        done
        echo ""
        if [[ "$READONLY_MODE" == true ]]; then
            echo -e "${GRAY}[READONLY MODE]${NC} Select a number (1-$count) to see path, or press Enter to cancel: "
        else
            echo -n "Select a number (1-$count) or press Enter to cancel: "
        fi
        read selection
        
        if [[ "$selection" =~ ^[0-9]+$ ]] && [[ "$selection" -ge 1 ]] && [[ "$selection" -le $count ]]; then
            local target_dir="${matches[$selection]}"
            echo -e "${GREEN}→${NC} ${target_dir}"
            if [[ "$READONLY_MODE" == true ]]; then
                echo -e "${GRAY}[READONLY MODE]${NC} Would navigate to: $target_dir"
                echo "Run: cd $target_dir"
            else
                echo "Path: $target_dir"
                echo "Run: cd $target_dir"
            fi
            return 0
        else
            echo "Cancelled"
            return 1
        fi
    fi
}

status_command() {
    echo -e "${YELLOW}Command 'status' is being implemented...${NC}"
    echo "This will show project activity status."
}

list_command() {
    echo -e "${YELLOW}Command 'list' is being implemented...${NC}"
    echo "This will list all projects."
}

ai_status_command() {
    echo -e "${YELLOW}Command 'ai-status' is being implemented...${NC}"
    echo "This will check AI development tools status."
}

# Run main function
main "$@"

# -----------------------------------------------------------------------------
# LICENSE (Apache 2.0)
#
# Copyright 2024 Augusto Sosa Escalada
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
# -----------------------------------------------------------------------------

