#!/usr/bin/env zsh

# godev - Development Directory Navigation Tool
# Version: 1.0.0

VERSION="2.1.11"
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/godev"
CONFIG_FILE="$CONFIG_DIR/config"

VERSION_FILE="$CONFIG_DIR/version_info"

# Colores
RED=$'\033[0;31m'
GREEN=$'\033[0;32m'
YELLOW=$'\033[1;33m'
BLUE=$'\033[0;34m'
MAGENTA=$'\033[0;35m'
CYAN=$'\033[0;36m'
GRAY=$'\033[0;90m'
BOLD=$'\033[1m'
NC=$'\033[0m' # No Color

# Patrones de exclusi√≥n
EXCLUDE_PATTERNS=(
    "node_modules"
    "dist"
    "build"
    "vendor"
    ".next"
    "target"
    "__pycache__"
    ".venv"
    "venv"
    ".pytest_cache"
    ".tox"
    "coverage"
    ".nuxt"
    "out"
)

# ============================================================================
# FUNCIONES DE CONFIGURACI√ìN
# ============================================================================

load_config() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo "${RED}Error: Configuraci√≥n no encontrada. Ejecuta: godev --setup${NC}" >&2
        return 1
    fi
    
    local env_base_dir="$GODEV_BASE_DIR"
    source "$CONFIG_FILE"
    [[ -n "$env_base_dir" ]] && GODEV_BASE_DIR="$env_base_dir"
    
    if [[ -z "$GODEV_BASE_DIR" ]]; then
        echo "${RED}Error: GODEV_BASE_DIR no configurado${NC}" >&2
        return 1
    fi
    
    if [[ ! -d "$GODEV_BASE_DIR" ]]; then
        echo "${RED}Error: Directorio base no existe: $GODEV_BASE_DIR${NC}" >&2
        return 1
    fi
    
    return 0
}

setup_config() {
    echo "${BOLD}${CYAN}üîß Configuraci√≥n de godev${NC}"
    echo ""
    
    # Crear directorio de configuraci√≥n
    mkdir -p "$CONFIG_DIR"
    
    # Preguntar por directorio base
    local default_base="$HOME/dev"
    echo -n "Directorio base para proyectos [${default_base}]: "
    read base_dir
    base_dir="${base_dir:-$default_base}"
    
    # Expandir ~ si est√° presente
    base_dir="${base_dir/#\~/$HOME}"
    
    # Crear directorio si no existe
    if [[ ! -d "$base_dir" ]]; then
        echo -n "${YELLOW}El directorio no existe. ¬øCrearlo? (s/N): ${NC}"
        read -k 1 create
        echo
        if [[ "$create" =~ ^[sS]$ ]]; then
            mkdir -p "$base_dir"
            echo "${GREEN}‚úì Directorio creado${NC}"
        else
            echo "${RED}Abortado${NC}"
            return 1
        fi
    fi
    
    # Verificar FZF
    local fzf_status="false"
    if command -v fzf &> /dev/null; then
        fzf_status="true"
        echo "${GREEN}‚úì FZF detectado${NC}"
    else
        echo "${YELLOW}‚ö† FZF no detectado${NC}"
        echo "  Se recomienda instalar FZF para mejor experiencia:"
        echo "  macOS: brew install fzf"
        echo "  Linux: sudo apt install fzf"
    fi
    
    # Guardar configuraci√≥n
    cat > "$CONFIG_FILE" <<EOF
# godev configuration
GODEV_BASE_DIR="$base_dir"
GODEV_FZF_ENABLED="$fzf_status"
EOF
    
    echo ""
    echo "${GREEN}‚úì Configuraci√≥n guardada en: $CONFIG_FILE${NC}"
    echo ""
    echo "${BOLD}Pr√≥ximos pasos:${NC}"
    echo "1. Aseg√∫rate de tener esto en tu ~/.zshrc:"
    echo ""
    echo "${CYAN}godev() {"
    echo "    local result"
    echo "    if [[ \"\$1\" =~ ^-- ]]; then"
    echo "        command ~/.local/bin/godev \"\$@\""
    echo "        return \$?"
    echo "    fi"
    echo "    result=\$(command ~/.local/bin/godev \"\$@\")"
    echo "    local exit_code=\$?"
    echo "    if [[ \$exit_code -eq 0 ]] && [[ -d \"\$result\" ]]; then"
    echo "        cd \"\$result\""
    echo "    else"
    echo "        echo \"\$result\""
    echo "        return \$exit_code"
    echo "    fi"
    echo "}${NC}"
    echo ""
    echo "2. Ejecuta: source ~/.zshrc"
    echo "3. Prueba: godev"
    
    return 0
}

# ============================================================================
# FUNCIONES DE ESCANEO
# ============================================================================

scan_projects() {
    local base_dir="$1"
    local -a projects
    
    local -A git_projects
    
    while IFS= read -r dir; do
        local dir_name="${dir##*/}"
        
        # 1. Skip hidden directories
        if [[ "$dir_name" == .* ]]; then
            continue
        fi
        
        # 2. Check exclusion patterns
        local exclude=0
        for pattern in "${EXCLUDE_PATTERNS[@]}"; do
            if [[ "$dir_name" == $pattern ]]; then
                exclude=1
                break
            fi
        done
        [[ $exclude -eq 1 ]] && continue
        
        # 3. Check if parent is a known git project
        # This prevents listing subdirectories of a git repo
        local parent_dir="${dir%/*}"
        if [[ -n "${git_projects[$parent_dir]}" ]]; then
            continue
        fi
        
        # 4. If current dir is a git repo, mark it
        if [[ -d "$dir/.git" ]]; then
            git_projects[$dir]=1
        fi
        
        projects+=("$dir")
    done < <(find "$base_dir" -mindepth 1 -maxdepth 2 -type d 2>/dev/null | sort)
    
    printf "%s\n" "${projects[@]}"
}

get_git_info() {
    local project_dir="$1"
    local -A info
    
    if [[ ! -d "$project_dir/.git" ]]; then
        info[has_git]="false"
        echo "has_git:false"
        return
    fi
    
    info[has_git]="true"
    
    # Branch
    local branch=$(git -C "$project_dir" rev-parse --abbrev-ref HEAD 2>/dev/null)
    info[branch]="${branch:-unknown}"
    
    # Status
    local git_status="clean"
    if ! git -C "$project_dir" diff-index --quiet HEAD -- 2>/dev/null; then
        git_status="modified"
    fi
    info[status]="$git_status"
    
    # √öltimo commit
    local last_commit=$(git -C "$project_dir" log -1 --format="%ar" 2>/dev/null)
    info[last_commit]="${last_commit:-never}"
    
    # Actividad √∫ltimos 30 d√≠as
    local activity=$(git -C "$project_dir" rev-list --count --since="30 days ago" HEAD 2>/dev/null)
    info[activity]="${activity:-0}"
    
    echo "has_git:true|branch:${info[branch]}|status:${info[status]}|last_commit:${info[last_commit]}|activity:${info[activity]}"
}



# ============================================================================
# FUNCIONES DE NAVEGACI√ìN
# ============================================================================

find_project() {
    local search="$1"
    local base_dir="$2"
    
    # B√∫squeda exacta primero
    local exact_match="$base_dir/$search"
    if [[ -d "$exact_match" ]]; then
        echo "$exact_match"
        return 0
    fi
    
    # B√∫squeda fuzzy - encontrar todos los que contengan el t√©rmino
    # Nota: scan_projects devuelve rutas absolutas
    # y find_project necesita buscar en el nombre relativo
    
    local -a matches
    local clean_base="${base_dir%/}"
    
    while IFS= read -r dir; do
        # Obtener nombre relativo (puede ser "proyecto" o "cliente/proyecto")
        local rel_name="${dir#$clean_base/}"
        
        # B√∫squeda case-insensitive en el nombre relativo
        if [[ "${rel_name:l}" == *"${search:l}"* ]]; then
            matches+=("$dir")
        fi
    done < <(scan_projects "$base_dir")
    
    case ${#matches[@]} in
        0)
            # No se encontr√≥ nada
            return 1
            ;;
        1)
            # Un solo match - ir directamente
            echo "${matches[1]}"
            return 0
            ;;
        *)
            # *** M√öLTIPLES MATCHES - MOSTRAR LISTA Y SELECCIONAR ***
            echo "" >&2
            echo "${BOLD}${CYAN}M√∫ltiples proyectos encontrados con '${search}':${NC}" >&2
            echo "" >&2
            
            # Usar FZF si est√° disponible
            if command -v fzf &> /dev/null && [[ "$GODEV_FZF_ENABLED" == "true" ]]; then
                local selected=$(printf '%s\n' "${matches[@]}" | fzf \
                    --height 50% \
                    --reverse \
                    --border rounded \
                    --prompt "Selecciona proyecto > " \
                    --header "‚Üë‚Üì navega | Enter selecciona | Esc cancela" \
                    --preview 'echo "üìÅ {}"; echo ""; if [[ -d "{}/.git" ]]; then echo "Git Info:"; git -C {} log -1 --pretty=format:"%Cgreen%h%Creset - %s %Cblue(%ar)%Creset" 2>/dev/null || echo "Sin commits"; echo ""; git -C {} status -s 2>/dev/null | head -5; else echo "‚ùå No es un repositorio git"; fi' \
                    --preview-window right:50%:wrap \
                    --color "header:italic:cyan,prompt:bold:blue")
                
                if [[ -n "$selected" ]]; then
                    echo "" >&2
                    echo "${GREEN}‚úì Seleccionado: ${selected##*/}${NC}" >&2
                    echo "$selected"
                    return 0
                else
                    echo "" >&2
                    echo "${YELLOW}Selecci√≥n cancelada${NC}" >&2
                    return 1
                fi
            else
                # Sin FZF - mostrar lista numerada con m√°s informaci√≥n
                echo "${GRAY}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}" >&2
                local i=1
                for match in "${matches[@]}"; do
                    local project_name="${match#$clean_base/}"
                    local git_info=""
                    
                    # Mostrar info de git si existe
                    if [[ -d "$match/.git" ]]; then
                        local branch=$(git -C "$match" rev-parse --abbrev-ref HEAD 2>/dev/null)
                        local status="clean"
                        if ! git -C "$match" diff-index --quiet HEAD -- 2>/dev/null; then
                            status="modified"
                        fi
                        if [[ "$status" == "modified" ]]; then
                            git_info="${GRAY}[${CYAN}$branch${GRAY} - ${YELLOW}‚óè${GRAY}]${NC}"
                        else
                            git_info="${GRAY}[${CYAN}$branch${GRAY} - ${GREEN}‚úì${GRAY}]${NC}"
                        fi
                    else
                        git_info="${GRAY}[no git]${NC}"
                    fi
                    
                    printf "${BOLD}%2d)${NC} %-35s %b\n" "$i" "$project_name" "$git_info" >&2
                    ((i++))
                done
                echo "${GRAY}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}" >&2
                echo "" >&2
                echo -n "${BOLD}Selecciona un n√∫mero (1-${#matches[@]}) o ${GRAY}Enter para cancelar${NC}: " >&2
                read selection
                
                # Validar selecci√≥n
                if [[ -z "$selection" ]]; then
                    echo "" >&2
                    echo "${YELLOW}Selecci√≥n cancelada${NC}" >&2
                    return 1
                elif [[ "$selection" =~ ^[0-9]+$ ]] && (( selection > 0 && selection <= ${#matches[@]} )); then
                    echo "" >&2
                    echo "${GREEN}‚úì Seleccionado: ${matches[$selection]#$clean_base/}${NC}" >&2
                    echo "${matches[$selection]}"
                    return 0
                else
                    echo "" >&2
                    echo "${RED}‚úó Selecci√≥n inv√°lida${NC}" >&2
                    return 1
                fi
            fi
            ;;
    esac
}

navigate_to_project() {
    local search="$1"
    
    load_config || return 1
    
    local project_path
    
    if [[ -z "$search" ]]; then
        # Sin argumento - men√∫ interactivo
        if command -v fzf &> /dev/null && [[ "$GODEV_FZF_ENABLED" == "true" ]]; then
            local clean_base="${GODEV_BASE_DIR%/}"
            project_path=$(scan_projects "$GODEV_BASE_DIR" | \
                # Mostrar nombre relativo en fzf
                while read item; do echo "${item#$clean_base/}"; done | \
                fzf --height 50% \
                    --reverse \
                    --border rounded \
                    --prompt "Selecciona proyecto > " \
                    --header "Todos los proyectos | ‚Üë‚Üì navega | Enter selecciona" \
                    --preview "echo 'üìÅ {}'; echo ''; full_path=\"$GODEV_BASE_DIR/{}\"; if [[ -d \"\$full_path/.git\" ]]; then echo 'Git Info:'; git -C \"\$full_path\" log -1 --pretty=format:\"%Cgreen%h%Creset - %s %Cblue(%ar)%Creset\" 2>/dev/null || echo 'Sin commits'; echo ''; git -C \"\$full_path\" status -s 2>/dev/null | head -5; else echo '‚ùå No es un repositorio git'; fi" \
                    --preview-window right:50%:wrap \
                    --color "header:italic:cyan,prompt:bold:blue")
            
            if [[ -z "$project_path" ]]; then
                echo "" >&2
                echo "${YELLOW}Selecci√≥n cancelada${NC}" >&2
                return 1
            fi
            
            # Convertir a ruta absoluta
            project_path="$GODEV_BASE_DIR/$project_path"
        else
            echo "${YELLOW}üí° Instala FZF para men√∫ interactivo: brew install fzf${NC}" >&2
            echo ""
            list_projects --simple
            return 1
        fi
    else
        project_path=$(find_project "$search" "$GODEV_BASE_DIR")
        local find_exit=$?
        
        # Si find_project retorn√≥ error y no encontr√≥ nada
        if [[ $find_exit -ne 0 ]] && [[ -z "$project_path" ]]; then
            echo "" >&2
            echo "${YELLOW}‚ö† Proyecto '$search' no encontrado${NC}" >&2
            echo "" >&2
            echo -n "¬øCrear nuevo proyecto '${BOLD}$search${NC}' en $GODEV_BASE_DIR? (${GREEN}s${NC}/${GRAY}N${NC}): " >&2
            read -k 1 create
            echo >&2
            echo "" >&2
            
            if [[ "$create" =~ ^[sS]$ ]]; then
                mkdir -p "$GODEV_BASE_DIR/$search"
                echo "${GREEN}‚úì Proyecto creado${NC}" >&2
                echo "$GODEV_BASE_DIR/$search"
                return 0
            else
                echo "${GRAY}Operaci√≥n cancelada${NC}" >&2
                return 1
            fi
        fi
    fi
    
    echo "$project_path"
    return 0
}

# ============================================================================
# FUNCI√ìN DE LISTADO
# ============================================================================

list_projects() {
    local simple_mode="$1"
    load_config || return 1
    
    if [[ "$simple_mode" == "--simple" ]]; then
        local clean_base="${GODEV_BASE_DIR%/}"
        scan_projects "$GODEV_BASE_DIR" | while read dir; do
            echo "  ${dir#$clean_base/}"
        done
        return 0
    fi
    
    # Parsear y mostrar
    echo ""
    printf "${BOLD}%-45s %-20s %-15s %-12s %-15s${NC}\n" "PROJECT" "LAST COMMIT" "BRANCH" "STATUS" "ACTIVITY (30d)"
    printf "%s\n" "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    
    local total=0
    local with_git=0
    local modified=0
    
    local clean_base="${GODEV_BASE_DIR%/}"
    
    while IFS= read -r project; do
        local name="${project#$clean_base/}"
        local git_raw=$(get_git_info "$project")
        
        # Parse git info from the "key:value|..." string returned by get_git_info
        local has_git=$(echo "$git_raw" | grep -o "has_git:[^|]*" | cut -d: -f2)
        
        printf "%-45s " "$name"
        
        if [[ "$has_git" == "true" ]]; then
            local last_commit=$(echo "$git_raw" | grep -o "last_commit:[^|]*" | cut -d: -f2)
            local branch=$(echo "$git_raw" | grep -o "branch:[^|]*" | cut -d: -f2)
            local project_status=$(echo "$git_raw" | grep -o "status:[^|]*" | cut -d: -f2)
            local activity=$(echo "$git_raw" | grep -o "activity:[^|]*" | cut -d: -f2)
            
            printf "%-20s " "$last_commit"
            printf "${CYAN}%-15s${NC} " "$branch"
            
            if [[ "$project_status" == "modified" ]]; then
                printf "${YELLOW}‚óè %-10s${NC} " "$project_status"
                ((modified++))
            else
                printf "${GREEN}‚úì %-10s${NC} " "$project_status"
            fi
            
            # Indicador de actividad
            local bars=""
            if (( activity > 20 )); then
                bars="${GREEN}‚óè‚óè‚óè${NC}"
            elif (( activity > 5 )); then
                bars="${YELLOW}‚óè‚óè‚óã${NC}"
            elif (( activity > 0 )); then
                bars="${GRAY}‚óè‚óã‚óã${NC}"
            else
                bars="${GRAY}‚óã‚óã‚óã${NC}"
            fi
            
            printf "%b (%-3s)\n" "$bars" "$activity"
            ((with_git++))
        else
            printf "${GRAY}%-20s %-15s %-12s %-15s${NC}\n" "NO_GIT" "N/A" "N/A" "‚óã‚óã‚óã"
        fi
        
        ((total++))
    done < <(scan_projects "$GODEV_BASE_DIR")
    
    printf "%s\n" "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo ""
    echo "${BOLD}Summary:${NC}"
    echo "    Total projects: $total"
    echo "    Git repositories: $with_git"
    echo "    Modified: $modified"
    printf "%s\n" "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
    echo ""
}

list_projects_with_pattern() {
    local search="$1"
    load_config || return 1

    echo ""
    echo "${BOLD}${CYAN}Proyectos que coinciden con '${search}':${NC}"
    echo ""

    printf "${BOLD}%-45s %-20s %-15s %-12s %-15s${NC}\n" "PROJECT" "LAST COMMIT" "BRANCH" "STATUS" "ACTIVITY (30d)"
    printf "%s\n" "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

    local total=0
    local with_git=0
    local modified=0
    local clean_base="${GODEV_BASE_DIR%/}"

    while IFS= read -r project; do
        local name="${project#$clean_base/}"

        # Filtrar por pattern (case-insensitive)
        if [[ ! "${name:l}" == *"${search:l}"* ]]; then
            continue
        fi

        local git_raw=$(get_git_info "$project")
        local has_git=$(echo "$git_raw" | grep -o "has_git:[^|]*" | cut -d: -f2)

        printf "%-45s " "$name"

        if [[ "$has_git" == "true" ]]; then
            local last_commit=$(echo "$git_raw" | grep -o "last_commit:[^|]*" | cut -d: -f2)
            local branch=$(echo "$git_raw" | grep -o "branch:[^|]*" | cut -d: -f2)
            local project_status=$(echo "$git_raw" | grep -o "status:[^|]*" | cut -d: -f2)
            local activity=$(echo "$git_raw" | grep -o "activity:[^|]*" | cut -d: -f2)

            printf "%-20s " "$last_commit"
            printf "${CYAN}%-15s${NC} " "$branch"

            if [[ "$project_status" == "modified" ]]; then
                printf "${YELLOW}‚óè %-10s${NC} " "$project_status"
                ((modified++))
            else
                printf "${GREEN}‚úì %-10s${NC} " "$project_status"
            fi

            # Indicador de actividad
            local bars=""
            if (( activity > 20 )); then
                bars="${GREEN}‚óè‚óè‚óè${NC}"
            elif (( activity > 5 )); then
                bars="${YELLOW}‚óè‚óè‚óã${NC}"
            elif (( activity > 0 )); then
                bars="${GRAY}‚óè‚óã‚óã${NC}"
            else
                bars="${GRAY}‚óã‚óã‚óã${NC}"
            fi

            printf "%b (%-3s)\n" "$bars" "$activity"
            ((with_git++))
        else
            printf "${GRAY}%-20s %-15s %-12s %-15s${NC}\n" "NO_GIT" "N/A" "N/A" "‚óã‚óã‚óã"
        fi

        ((total++))
    done < <(scan_projects "$GODEV_BASE_DIR")

    printf "%s\n" "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"

    if [[ $total -eq 0 ]]; then
        echo ""
        echo "${YELLOW}‚ö† No se encontraron proyectos con '${search}'${NC}"
        echo ""
        return 1
    fi

    echo ""
    echo "${BOLD}Total: $total proyecto(s)${NC}"
    echo ""
    return 0
}

# ============================================================================
# COMANDOS PRINCIPALES
# ============================================================================

show_help() {
    cat <<EOF
${BOLD}${CYAN}üöÄ godev${NC} - Demystify Your Development Tree v${VERSION}

${BOLD}Navigate 100+ projects in seconds. Make sense of complexity.${NC}

${BOLD}NAVEGACI√ìN:${NC}
    ${CYAN}godev${NC}                   ${GRAY}# Men√∫ interactivo (FZF)${NC}
    ${CYAN}godev <nombre>${NC}          ${GRAY}# Cambiar a proyecto${NC}
    ${CYAN}godev <parcial>${NC}         ${GRAY}# Buscar y seleccionar si m√∫ltiples${NC}

${BOLD}LISTADO:${NC}
    ${CYAN}godev --list${NC}            ${GRAY}# Listar TODOS los proyectos${NC}
    ${CYAN}godev -l${NC}                ${GRAY}# (forma corta)${NC}
    ${CYAN}godev <pattern> -l${NC}      ${GRAY}# Listar proyectos que coincidan${NC}

${BOLD}OTROS COMANDOS:${NC}
    ${CYAN}--setup${NC}                 ${GRAY}# Configurar/reconfigurar godev${NC}
    ${CYAN}--version, -v${NC}           ${GRAY}# Mostrar versi√≥n${NC}
    ${CYAN}--help, -h${NC}              ${GRAY}# Mostrar esta ayuda${NC}

${BOLD}EJEMPLOS:${NC}
    ${GREEN}godev${NC}                     ${GRAY}# Selector interactivo de todos los proyectos${NC}
    ${GREEN}godev web${NC}                 ${GRAY}# Navega a "web" o selector si m√∫ltiples${NC}
    ${GREEN}godev my-app${NC}              ${GRAY}# Va a my-app (o lo crea si no existe)${NC}
    ${GREEN}godev -l${NC}                  ${GRAY}# Lista todos los proyectos${NC}
    ${GREEN}godev web -l${NC}              ${GRAY}# Lista solo proyectos con "web"${NC}
    ${GREEN}godev alithya -l${NC}          ${GRAY}# Lista proyectos del cliente "alithya"${NC}

${BOLD}CARACTER√çSTICAS:${NC}
    ${GREEN}‚úì${NC} B√∫squeda fuzzy inteligente
    ${GREEN}‚úì${NC} Integraci√≥n con FZF para mejor UX
    ${GREEN}‚úì${NC} Informaci√≥n Git detallada
    ${GREEN}‚úì${NC} Informaci√≥n Git detallada
    ${GREEN}‚úì${NC} Seguimiento de actividad (30 d√≠as)
    ${GREEN}‚úì${NC} Selecci√≥n m√∫ltiple autom√°tica

${BOLD}CONFIGURACI√ìN:${NC}
    Archivo: ${CYAN}${CONFIG_FILE}${NC}
    
${BOLD}RECOMENDACI√ìN:${NC}
    Instala FZF para experiencia premium: ${CYAN}brew install fzf${NC}

${BOLD}M√ÅS INFO:${NC}
    GitHub: ${CYAN}https://github.com/augustose/godev${NC}
    Docs: ${CYAN}README.md, architecture.md, testing_guide.md${NC}

${GRAY}Made with ‚ù§Ô∏è  for developers who value their time${NC}

EOF
}

show_version() {
    echo "godev version ${VERSION}"
}

# ============================================================================
# MAIN
# ============================================================================

main() {
    # Verificar que estamos en ZSH
    if [[ -z "$ZSH_VERSION" ]]; then
        echo "${RED}Error: Este script requiere ZSH${NC}" >&2
        return 1
    fi
    
    # Parsear comandos
    case "$1" in
        --help|-h)
            show_help
            return 0
            ;;
        --version|-v)
            show_version
            return 0
            ;;
        --setup)
            setup_config
            return $?
            ;;
        --list|-l)
            list_projects "$2"
            return $?
            ;;
        --update)
            echo "${YELLOW}Funci√≥n de actualizaci√≥n en desarrollo${NC}"
            return 0
            ;;
        *)
            # Verificar si el segundo argumento es -l (listar con pattern)
            if [[ "$2" == "-l" ]]; then
                list_projects_with_pattern "$1"
                return $?
            fi

            # Navegaci√≥n normal
            navigate_to_project "$1"
            return $?
            ;;
    esac
}

# Ejecutar main con todos los argumentos
main "$@"
